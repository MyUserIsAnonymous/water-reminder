<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8B0000">
    <meta name="description" content="Droplet - Your cute animal hydration companion">
    <title>Droplet</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/droplet-icon-192.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Comic+Neue:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="apple-touch-icon" href="icons/droplet-icon-192.png">
    <link rel="icon" type="image/png" href="icons/droplet-icon-192.png">
    <style>
        /* [KEEP ALL YOUR EXISTING MAROON STYLES] */
        :root {
            --maroon: #8B0000;
            --maroon-light: #B22222;
            --maroon-dark: #5D0000;
            --maroon-pink: #D81B60;
            --maroon-rose: #E91E63;
            --maroon-warm: #C2185B;
            --gold: #D4AF37;
            --cream: #FFF8E1;
            --text: #5D4037;
            --text-light: #8D6E63;
            --white: #ffffff;
            --white-transparent: rgba(255, 255, 255, 0.92);
            --shadow: rgba(139, 0, 0, 0.15);
            --radius: 28px;
            --radius-small: 18px;
        }
        
        /* [KEEP ALL YOUR EXISTING CSS] */
        /* ... */
        
        /* ADD THIS NEW STYLE FOR iOS MESSAGE */
        .ios-message {
            background: linear-gradient(135deg, var(--maroon), var(--maroon-pink));
            color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin: 15px 0;
            text-align: center;
            border: 3px solid white;
            display: none;
        }
        
        .ios-message.show {
            display: block;
            animation: pulse 2s infinite;
        }
        
        .ios-message h4 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .ios-message p {
            font-size: 0.9rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .ios-message .emoji {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }
    </style>
</head>
<body>
    <!-- [KEEP ALL YOUR EXISTING HTML] -->
    
    <!-- ADD THIS RIGHT AFTER THE REMINDER SECTION -->
    <div class="ios-message" id="iosMessage">
        <div class="emoji">üì±üíß</div>
        <h4>iPhone Tip</h4>
        <p>Keep this app open or add to Home Screen for reminders! üîî</p>
        <p><small>iOS shows notifications only when app is open</small></p>
    </div>
    
    <!-- REPLACE THE ENTIRE SCRIPT WITH THIS SIMPLE WORKING VERSION: -->
    <script>
        // ============================================
        // SIMPLE WORKING VERSION FOR ALL DEVICES
        // ============================================
        
        // DOM Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const homeScreen = document.getElementById('homeScreen');
        const timerDisplay = document.getElementById('timerDisplay');
        const timerStatus = document.getElementById('timerStatus');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const drinkNowBtn = document.getElementById('drinkNowBtn');
        const getStartedBtn = document.getElementById('getStartedBtn');
        const reminderSection = document.getElementById('reminderSection');
        const reminderDrankBtn = document.getElementById('reminderDrankBtn');
        const iosMessage = document.getElementById('iosMessage');
        
        // Check if iPhone
        const isIPhone = /iPhone|iPad|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        // App State
        let totalSeconds = 30 * 60; // 30 minutes
        let remainingSeconds = totalSeconds;
        let timerInterval = null;
        let isRunning = false;
        let litersDrunk = 0;
        let dailyBottles = 3;
        
        // Initialize
        function init() {
            loadState();
            setupEventListeners();
            updateTimerDisplay();
            
            // Show iOS message if on iPhone
            if (isIPhone) {
                iosMessage.classList.add('show');
                
                // Show iPhone instructions
                setTimeout(() => {
                    alert("üì± iPhone User:\n\nFor best experience:\n1. Keep this app OPEN\n2. Or add to Home Screen\n3. Enable sound\n\nApp must be open to show reminders! ‚ú®");
                }, 1000);
            }
            
            // Auto-start if returning user
            if (localStorage.getItem('dropletFirstTime') === 'false') {
                welcomeScreen.classList.remove('active');
                homeScreen.classList.add('active');
            }
        }
        
        // Load state
        function loadState() {
            const saved = localStorage.getItem('dropletState');
            if (saved) {
                const data = JSON.parse(saved);
                litersDrunk = data.litersDrunk || 0;
                dailyBottles = data.dailyBottles || 3;
            }
        }
        
        // Save state
        function saveState() {
            localStorage.setItem('dropletState', JSON.stringify({
                litersDrunk: litersDrunk,
                dailyBottles: dailyBottles,
                lastUpdated: new Date().toISOString()
            }));
        }
        
        // Setup event listeners
        function setupEventListeners() {
            getStartedBtn.addEventListener('click', () => {
                welcomeScreen.classList.remove('active');
                homeScreen.classList.add('active');
                localStorage.setItem('dropletFirstTime', 'false');
                playSound();
            });
            
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            resetBtn.addEventListener('click', resetTimer);
            drinkNowBtn.addEventListener('click', drinkWater);
            reminderDrankBtn.addEventListener('click', drinkWater);
        }
        
        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Color coding
            if (remainingSeconds > 1200) {
                timerDisplay.style.color = "var(--maroon)";
            } else if (remainingSeconds > 600) {
                timerDisplay.style.color = "var(--gold)";
            } else {
                timerDisplay.style.color = "var(--maroon-pink)";
            }
        }
        
        // Start timer
        function startTimer() {
            if (isRunning) return;
            
            isRunning = true;
            timerStatus.textContent = "Timer running! Next reminder in 30 minutes ‚è∞üíñ";
            
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay();
                
                // Status updates
                if (remainingSeconds === 1200) {
                    timerStatus.textContent = "20 minutes to go! Keep it up! üí™‚ú®";
                } else if (remainingSeconds === 600) {
                    timerStatus.textContent = "10 minutes left! Almost time! üíßüêæ";
                } else if (remainingSeconds === 300) {
                    timerStatus.textContent = "5 minutes left! Get ready! üö∞üíï";
                } else if (remainingSeconds === 60) {
                    timerStatus.textContent = "One minute left! ‚è≥üéÄ";
                } else if (remainingSeconds <= 0) {
                    triggerReminder();
                }
            }, 1000);
            
            playSound();
        }
        
        // Pause timer
        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            timerStatus.textContent = "Timer paused ‚è∏Ô∏èüí§";
            playSound();
        }
        
        // Reset timer
        function resetTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            remainingSeconds = totalSeconds;
            updateTimerDisplay();
            timerStatus.textContent = "Timer reset! Tap start to begin üíßüíñ";
            reminderSection.classList.remove('show');
            playSound();
        }
        
        // ============================================
        // WORKING NOTIFICATION SYSTEM FOR ALL DEVICES
        // ============================================
        
        // Trigger reminder
        function triggerReminder() {
            console.log("‚è∞ REMINDER TRIGGERED!");
            
            // 1. Show in-app reminder (ALWAYS WORKS)
            reminderSection.classList.add('show');
            reminderSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // 2. Try browser notification (works on Android/Desktop)
            tryBrowserNotification();
            
            // 3. Play sound (works when app is open)
            playReminderSound();
            
            // 4. Vibrate if supported
            tryVibration();
            
            // 5. Show alert for iOS (when app is in background)
            if (isIPhone && document.hidden) {
                showIOSBackgroundAlert();
            }
            
            // Pause timer
            pauseTimer();
            
            // Start checking for drink every 5 minutes
            startFollowUpReminders();
        }
        
        // Try browser notification
        function tryBrowserNotification() {
            if (!("Notification" in window)) return;
            
            if (Notification.permission === "granted") {
                // Send notification
                const notification = new Notification("üíß Time to Drink!", {
                    body: "It's been 30 minutes! Drink 1L of water üí¶",
                    icon: "icons/droplet-icon-192.png",
                    tag: "droplet-reminder",
                    silent: true // Don't make sound (iOS blocks it)
                });
                
                // Close after 10 seconds
                setTimeout(() => notification.close(), 10000);
                
                // Click to focus app
                notification.onclick = () => {
                    window.focus();
                    notification.close();
                };
                
            } else if (Notification.permission === "default" && !isIPhone) {
                // Only ask on non-iOS devices
                Notification.requestPermission();
            }
        }
        
        // iOS background alert
        function showIOSBackgroundAlert() {
            // This only shows when user returns to the app
            console.log("üì± iOS: User was away during reminder");
            // We'll show a message when they return
            localStorage.setItem('missedReminder', 'true');
        }
        
        // Play reminder sound
        function playReminderSound() {
            try {
                // Create beep sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Pleasant chime
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
                oscillator.frequency.exponentialRampToValueAtTime(600, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
                
            } catch (e) {
                console.log("Sound not supported");
            }
        }
        
        // Play general sound
        function playSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                // Sound not supported
            }
        }
        
        // Try vibration
        function tryVibration() {
            if ("vibrate" in navigator) {
                try {
                    // Vibrate pattern: short-long-short
                    navigator.vibrate([100, 200, 100]);
                } catch (e) {
                    // Vibration not supported
                }
            }
        }
        
        // Start follow-up reminders
        let followUpInterval = null;
        
        function startFollowUpReminders() {
            // Clear any existing
            if (followUpInterval) clearInterval(followUpInterval);
            
            let minutesPassed = 0;
            
            followUpInterval = setInterval(() => {
                minutesPassed += 1;
                
                // Every 5 minutes, remind again
                if (minutesPassed % 5 === 0 && reminderSection.classList.contains('show')) {
                    timerStatus.textContent = `Still waiting... ${minutesPassed} minutes passed ‚è≥`;
                    
                    // Play gentle reminder sound
                    playSound();
                    
                    // Try notification again
                    tryBrowserNotification();
                }
                
                // Stop after 30 minutes
                if (minutesPassed >= 30) {
                    clearInterval(followUpInterval);
                    reminderSection.classList.remove('show');
                    resetTimer();
                }
                
            }, 60000); // Check every minute
        }
        
        // Drink water
        function drinkWater() {
            litersDrunk += 1;
            remainingSeconds = totalSeconds;
            updateTimerDisplay();
            
            // Hide reminder
            reminderSection.classList.remove('show');
            
            // Clear follow-up reminders
            if (followUpInterval) {
                clearInterval(followUpInterval);
                followUpInterval = null;
            }
            
            // Update status
            const litersLeft = (dailyBottles * 2) - litersDrunk;
            if (litersLeft > 0) {
                timerStatus.textContent = `Yay! 1L recorded! ${litersLeft.toFixed(1)}L to go! üéâüíï`;
            } else {
                timerStatus.textContent = `üéä Amazing! Daily goal reached! ‚≠ê‚ú®`;
            }
            
            // Restart timer if not running
            if (!isRunning) {
                startTimer();
            }
            
            // Save and play sound
            saveState();
            playSound();
        }
        
        // ============================================
        // PAGE VISIBILITY HANDLING
        // ============================================
        
        // Check for missed reminders when app becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // App just became visible
                const missed = localStorage.getItem('missedReminder');
                if (missed === 'true') {
                    // Show missed reminder alert
                    timerStatus.textContent = "‚è∞ You missed a reminder while away!";
                    localStorage.removeItem('missedReminder');
                    
                    // Show reminder section
                    reminderSection.classList.add('show');
                }
            } else {
                // App just became hidden
                saveState(); // Save when user leaves
            }
        });
        
        // ============================================
        // AUTO-SAVE & CLEANUP
        // ============================================
        
        // Auto-save every minute
        setInterval(saveState, 60000);
        
        // Save on unload
        window.addEventListener('beforeunload', saveState);
        
        // Check for drink every 10 seconds when reminder is showing
        setInterval(() => {
            if (reminderSection.classList.contains('show')) {
                // Update status to show how long they've been waiting
                const waitTime = Math.floor((30 * 60 - remainingSeconds) / 60);
                if (waitTime > 0) {
                    timerStatus.textContent = `Waiting ${waitTime} minutes for you to drink... ‚è≥`;
                }
            }
        }, 10000);
        
        // Initialize
        window.addEventListener('DOMContentLoaded', init);
        
        // Debug info
        console.log("üíß Droplet v4.0 loaded");
        console.log("Device:", isIPhone ? "iPhone/iPad" : "Other");
        console.log("Browser:", isSafari ? "Safari" : "Other");
        
    </script>
</body>
</html>
